<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>April英语游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7B61FF',
                        secondary: '#36D399',
                        danger: '#F87272',
                        neutral: '#64748B',
                        light: '#F8FAFC',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-1;
            }
            .card-effect {
                @apply bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300;
            }
            .loading-spinner {
                @apply animate-spin h-5 w-5 border-2 border-primary border-t-transparent rounded-full inline-block;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen font-sans">
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary flex items-center">
                <i class="fa fa-graduation-cap mr-2"></i>April英语游戏
            </h1>
            <div class="flex items-center space-x-4">
                <div id="timer" class="hidden md:flex items-center bg-light px-3 py-1 rounded-lg border border-gray-200">
                    <i class="fa fa-clock-o text-neutral mr-2"></i>
                    <span id="time-display">00:00</span>
                </div>
                <button id="reset-btn" class="bg-neutral hover:bg-neutral/80 text-white px-4 py-2 rounded-lg btn-hover hidden">
                    <i class="fa fa-refresh mr-1"></i> 重新开始
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 单词输入区域 -->
        <section id="word-input-section" class="card-effect p-6 md:p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6 text-center">添加学习单词</h2>
            
            <div class="mb-8">
                <h3 class="font-semibold text-lg mb-3">批量导入单词</h3>
                <p class="text-gray-600 text-sm mb-3">请输入英文单词，用空格或回车分隔（例如：apple banana cat）</p>
                <textarea id="bulk-words" rows="6" 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                          placeholder="在这里输入多个英文单词，用空格或回车分隔"></textarea>
                <div class="mt-3 flex justify-end">
                    <button id="import-words" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg btn-hover flex items-center">
                        <i class="fa fa-upload mr-2"></i>导入并生成释义
                        <span id="import-loading" class="ml-2 hidden"><span class="loading-spinner"></span></span>
                    </button>
                </div>
            </div>
            
            <!-- 分享链接区域 -->
            <div id="share-link-section" class="mb-6 hidden">
                <div class="bg-purple-50 border border-purple-100 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3 flex items-center">
                        <i class="fa fa-link text-primary mr-2"></i>游戏分享链接
                    </h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="game-share-link" readonly
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-white"
                               placeholder="生成的游戏链接将显示在这里">
                        <button id="copy-link-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg btn-hover whitespace-nowrap">
                            <i class="fa fa-copy mr-1"></i>复制链接
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="word-list" class="mt-6">
                <h3 class="font-semibold text-lg mb-3 flex items-center">
                    <i class="fa fa-list-ul text-neutral mr-2"></i>已添加单词（可点击释义进行修改）
                </h3>
                <ul id="words-container" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <li class="text-gray-500 italic text-center py-4">尚未添加单词</li>
                </ul>
                
                <button id="start-game" class="w-full mt-6 bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-4 rounded-lg btn-hover opacity-50 cursor-not-allowed" disabled>
                    <i class="fa fa-play-circle mr-2"></i>开始游戏
                </button>
            </div>
        </section>
        
        <!-- 游戏区域 -->
        <section id="game-section" class="hidden card-effect p-6 md:p-8 mb-8">
            <div class="text-center mb-8">
                <div class="inline-block bg-light px-4 py-2 rounded-full mb-2 text-sm font-medium">
                    <span id="current-word-index">1</span> / <span id="total-words">0</span>
                </div>
                <h2 id="current-word" class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary"></h2>
            </div>
            
            <div id="options-container" class="space-y-4 mb-8">
                <div class="text-center py-8" id="options-loading">
                    <span class="loading-spinner"></span>
                    <p class="mt-2 text-gray-500">加载选项中...</p>
                </div>
            </div>
            
            <div id="feedback" class="hidden mb-6 p-4 rounded-lg text-center font-medium"></div>
        </section>
        
        <!-- 结果统计区域 -->
        <section id="results-section" class="hidden card-effect p-6 md:p-8">
            <h2 class="text-2xl font-bold mb-6 text-center">游戏结果</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                <div class="bg-light p-5 rounded-lg">
                    <div class="text-3xl font-bold text-primary mb-1" id="total-questions">0</div>
                    <div class="text-gray-600">总单词数</div>
                </div>
                <div class="bg-light p-5 rounded-lg">
                    <div class="text-3xl font-bold text-secondary mb-1" id="accuracy">0%</div>
                    <div class="text-gray-600">正确率</div>
                </div>
                <div class="bg-light p-5 rounded-lg">
                    <div class="text-3xl font-bold text-neutral mb-1" id="total-time">00:00</div>
                    <div class="text-gray-600">总用时</div>
                </div>
            </div>
            
            <div id="mistakes-section" class="mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-exclamation-circle text-danger mr-2"></i>错误单词回顾
                </h3>
                <div id="mistakes-list" class="space-y-4">
                    <!-- 错误单词将通过JS动态生成 -->
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="review-again" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg btn-hover">
                    <i class="fa fa-repeat mr-2"></i>重新练习错题
                </button>
                <button id="new-game" class="flex-1 bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-4 rounded-lg btn-hover">
                    <i class="fa fa-plus-circle mr-2"></i>添加新单词
                </button>
            </div>
        </section>
    </main>

    <footer class="bg-white mt-8 py-6 shadow-inner">
        <div class="container mx-auto px-4 text-center text-gray-600">
            <p>April英语游戏 &copy; 2023 - 提升你的词汇量</p>
        </div>
    </footer>

    <script>
        // 确保错误选项为中文的大型词汇库
        const chineseVocabulary = [
            // 名词 - 自然
            "天空", "大地", "河流", "山脉", "森林", "花朵", "树木", "阳光", "月亮", "星星",
            "风雨", "雷电", "冰雪", "火焰", "岩石", "土壤", "沙漠", "海洋", "岛屿", "草原",
            
            // 名词 - 生活
            "家庭", "学校", "医院", "商店", "公园", "城市", "乡村", "房屋", "街道", "车辆",
            "食物", "衣服", "书籍", "电脑", "手机", "工具", "玩具", "乐器", "家具", "电器",
            
            // 动词
            "行走", "奔跑", "跳跃", "飞翔", "游泳", "学习", "工作", "玩耍", "休息", "思考",
            "阅读", "书写", "绘画", "歌唱", "舞蹈", "购买", "销售", "给予", "接受", "创造",
            
            // 形容词
            "美丽", "丑陋", "高大", "矮小", "强壮", "虚弱", "快乐", "悲伤", "聪明", "愚蠢",
            "快速", "缓慢", "年轻", "年老", "正确", "错误", "简单", "复杂", "重要", "次要",
            
            // 抽象名词
            "爱情", "友情", "亲情", "希望", "梦想", "勇气", "智慧", "诚实", "善良", "美丽",
            "时间", "空间", "自由", "责任", "成功", "失败", "幸福", "痛苦", "和平", "战争"
        ];

        // 游戏数据
        const gameData = {
            words: [],          // {word, correctMeaning}
            currentWordIndex: 0,
            startTime: null,
            timerInterval: null,
            secondsElapsed: 0,
            attempts: {},
            mistakes: []
        };

        // DOM元素
        const elements = {
            wordInputSection: document.getElementById('word-input-section'),
            gameSection: document.getElementById('game-section'),
            resultsSection: document.getElementById('results-section'),
            wordsContainer: document.getElementById('words-container'),
            startGameBtn: document.getElementById('start-game'),
            currentWord: document.getElementById('current-word'),
            currentWordIndex: document.getElementById('current-word-index'),
            totalWords: document.getElementById('total-words'),
            optionsContainer: document.getElementById('options-container'),
            optionsLoading: document.getElementById('options-loading'),
            feedback: document.getElementById('feedback'),
            timerDisplay: document.getElementById('time-display'),
            resetBtn: document.getElementById('reset-btn'),
            totalQuestions: document.getElementById('total-questions'),
            accuracy: document.getElementById('accuracy'),
            totalTime: document.getElementById('total-time'),
            mistakesList: document.getElementById('mistakes-list'),
            reviewAgainBtn: document.getElementById('review-again'),
            newGameBtn: document.getElementById('new-game'),
            bulkWords: document.getElementById('bulk-words'),
            importWordsBtn: document.getElementById('import-words'),
            importLoading: document.getElementById('import-loading'),
            shareLinkSection: document.getElementById('share-link-section'),
            gameShareLink: document.getElementById('game-share-link'),
            copyLinkBtn: document.getElementById('copy-link-btn')
        };

        // 生成随机中文错误选项（确保是中文）
        function generateChineseDistractors(count, correctAnswer) {
            // 复制并打乱词汇库
            const shuffled = [...chineseVocabulary].sort(() => 0.5 - Math.random());
            
            // 筛选与正确答案不同的选项
            const distractors = [];
            for (const word of shuffled) {
                if (word !== correctAnswer && !distractors.includes(word)) {
                    distractors.push(word);
                    if (distractors.length === count) break;
                }
            }
            
            // 确保有足够的选项
            while (distractors.length < count) {
                // 生成随机汉字组合作为备用
                const randomChars = '金木水火土天地日月星辰春夏秋冬东南西北前后左右高低多少';
                let newWord = '';
                const length = Math.floor(Math.random() * 2) + 1; // 1-2个字符
                for (let i = 0; i < length; i++) {
                    newWord += randomChars.charAt(Math.floor(Math.random() * randomChars.length));
                }
                if (newWord !== correctAnswer && !distractors.includes(newWord)) {
                    distractors.push(newWord);
                }
            }
            
            return distractors;
        }

        // 翻译单词（确保返回中文）
        async function translateWord(word) {
            // 内置常见单词中文释义（优先使用）
            const commonTranslations = {
                "marriage": "婚姻",
                "residence": "居住地",
                "elevate": "提升",
                "usage": "用法",
                "apple": "苹果",
                "banana": "香蕉",
                "book": "书",
                "computer": "电脑",
                "friend": "朋友",
                "happy": "高兴的",
                "school": "学校",
                "teacher": "老师",
                "student": "学生",
                "water": "水",
                "family": "家庭"
            };
            
            // 先检查内置翻译
            if (commonTranslations[word.toLowerCase()]) {
                return commonTranslations[word.toLowerCase()];
            }
            
            // 尝试API翻译
            try {
                const response = await axios.get('https://api.mymemory.translated.net/get', {
                    params: {
                        q: word,
                        langpair: 'en|zh-CN'
                    }
                });
                
                if (response.data.responseStatus === 200 && response.data.responseData) {
                    return response.data.responseData.translatedText || `[请编辑: ${word}]`;
                }
            } catch (error) {
                console.error('翻译API调用失败，使用默认中文提示');
            }
            
            // 全部失败时返回可编辑的中文提示
            return `[请编辑: ${word}]`;
        }

        // 生成分享链接（修复版）
        function generateShareLink() {
            if (gameData.words.length === 0) return null;
            
            try {
                // 确保数据正确序列化
                const wordsStr = JSON.stringify(gameData.words);
                
                // 安全的Base64编码处理
                let encoded;
                try {
                    encoded = btoa(unescape(encodeURIComponent(wordsStr)));
                } catch (e) {
                    // 降级编码方式
                    encoded = btoa(wordsStr);
                }
                
                // 构建基础URL
                let baseUrl = window.location.protocol + "//" + window.location.host;
                baseUrl += window.location.pathname;
                
                // 生成完整分享链接
                const shareUrl = baseUrl + "#" + encoded;
                
                // 显示链接
                elements.gameShareLink.value = shareUrl;
                elements.shareLinkSection.classList.remove('hidden');
                
                return shareUrl;
            } catch (e) {
                console.error('分享链接生成失败:', e);
                alert('分享链接生成失败: ' + e.message + '\n已自动简化数据格式重试');
                
                // 尝试简化数据格式
                try {
                    const simplified = gameData.words.map(item => ({
                        w: item.word,
                        m: item.correctMeaning
                    }));
                    const str = JSON.stringify(simplified);
                    const encoded = btoa(str);
                    const shareUrl = window.location.href.split('#')[0] + "#" + encoded;
                    elements.gameShareLink.value = shareUrl;
                    elements.shareLinkSection.classList.remove('hidden');
                    return shareUrl;
                } catch (e2) {
                    console.error('简化格式也失败:', e2);
                    alert('无法生成分享链接，请减少单词数量后重试');
                    return null;
                }
            }
        }

        // 从URL加载单词数据（兼容新旧格式）
        function loadWordsFromUrl() {
            const hash = window.location.hash.substring(1);
            if (!hash) return false;
            
            try {
                // 解码
                const decoded = decodeURIComponent(escape(atob(hash)));
                let words = JSON.parse(decoded);
                
                // 兼容简化格式
                if (words.length > 0 && words[0].w) {
                    words = words.map(item => ({
                        word: item.w,
                        correctMeaning: item.m
                    }));
                }
                
                if (Array.isArray(words) && words.length > 0) {
                    gameData.words = words;
                    updateWordList();
                    elements.startGameBtn.disabled = false;
                    elements.startGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return true;
                }
            } catch (e) {
                console.error('从URL加载失败:', e);
            }
            
            return false;
        }

        // 批量导入单词
        async function importWords() {
            const text = elements.bulkWords.value.trim();
            if (!text) {
                alert('请输入要导入的单词');
                return;
            }
            
            const words = text.split(/[\s\n]+/).filter(word => word.trim() !== '');
            if (words.length === 0) {
                alert('未识别到有效单词');
                return;
            }
            
            elements.importWordsBtn.disabled = true;
            elements.importLoading.classList.remove('hidden');
            
            try {
                let addedCount = 0;
                
                for (const word of words) {
                    // 检查重复
                    const exists = gameData.words.some(item => 
                        item.word.toLowerCase() === word.toLowerCase()
                    );
                    if (exists) continue;
                    
                    // 获取中文释义
                    const meaning = await translateWord(word);
                    
                    gameData.words.push({ word, correctMeaning: meaning });
                    addedCount++;
                }
                
                updateWordList();
                generateShareLink();
                
                if (gameData.words.length > 0) {
                    elements.startGameBtn.disabled = false;
                    elements.startGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                alert(`成功导入 ${addedCount} 个单词（已过滤重复单词）`);
                elements.bulkWords.value = '';
            } catch (error) {
                console.error('导入失败:', error);
                alert('导入过程中发生错误，请重试');
            } finally {
                elements.importWordsBtn.disabled = false;
                elements.importLoading.classList.add('hidden');
            }
        }

        // 更新单词列表显示
        function updateWordList() {
            elements.wordsContainer.innerHTML = '';
            
            if (gameData.words.length === 0) {
                elements.wordsContainer.innerHTML = 
                    '<li class="text-gray-500 italic text-center py-4">尚未添加单词</li>';
                elements.shareLinkSection.classList.add('hidden');
                return;
            }
            
            gameData.words.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-light p-3 rounded-lg border border-gray-100';
                li.innerHTML = `
                    <div>
                        <span class="font-semibold">${item.word}</span>
                        <span class="text-primary ml-2 cursor-pointer edit-meaning" data-index="${index}">
                            <i class="fa fa-pencil mr-1"></i>${item.correctMeaning}
                        </span>
                    </div>
                    <button class="delete-word text-gray-400 hover:text-danger" data-index="${index}">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                elements.wordsContainer.appendChild(li);
            });
            
            // 添加编辑事件
            document.querySelectorAll('.edit-meaning').forEach(span => {
                span.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    const wordData = gameData.words[index];
                    const newMeaning = prompt(`修改 "${wordData.word}" 的中文释义:`, wordData.correctMeaning);
                    if (newMeaning !== null && newMeaning.trim() !== '') {
                        gameData.words[index].correctMeaning = newMeaning.trim();
                        updateWordList();
                        generateShareLink();
                    }
                });
            });
            
            // 添加删除事件
            document.querySelectorAll('.delete-word').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    gameData.words.splice(index, 1);
                    updateWordList();
                    if (gameData.words.length > 0) {
                        generateShareLink();
                    } else {
                        elements.startGameBtn.disabled = true;
                        elements.startGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
            });
        }

        // 开始游戏
        function startGame() {
            gameData.currentWordIndex = 0;
            gameData.secondsElapsed = 0;
            gameData.attempts = {};
            gameData.mistakes = [];
            
            gameData.words.forEach((_, index) => {
                gameData.attempts[index] = 0;
            });
            
            elements.wordInputSection.classList.add('hidden');
            elements.gameSection.classList.remove('hidden');
            elements.resetBtn.classList.remove('hidden');
            elements.totalWords.textContent = gameData.words.length;
            
            loadWord(gameData.currentWordIndex);
            startTimer();
        }

        // 加载单词和选项
        function loadWord(index) {
            const wordData = gameData.words[index];
            elements.currentWord.textContent = wordData.word;
            elements.currentWordIndex.textContent = index + 1;
            
            elements.optionsContainer.innerHTML = '';
            elements.optionsContainer.appendChild(elements.optionsLoading);
            elements.feedback.classList.add('hidden');
            
            try {
                // 生成两个中文错误选项
                const wrongAnswers = generateChineseDistractors(2, wordData.correctMeaning);
                
                // 组合所有选项并随机排序
                const allOptions = [
                    { text: wordData.correctMeaning, isCorrect: true },
                    { text: wrongAnswers[0], isCorrect: false },
                    { text: wrongAnswers[1], isCorrect: false }
                ].sort(() => Math.random() - 0.5);
                
                // 显示选项
                elements.optionsContainer.innerHTML = '';
                allOptions.forEach((option, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-4 border border-gray-200 rounded-lg hover:border-primary hover:bg-primary/5 transition-all btn-hover';
                    btn.innerHTML = `<span class="font-medium mr-2">${String.fromCharCode(65 + i)}</span>${option.text}`;
                    btn.dataset.isCorrect = option.isCorrect;
                    btn.addEventListener('click', () => checkAnswer(btn, option.isCorrect));
                    elements.optionsContainer.appendChild(btn);
                });
            } catch (error) {
                console.error('加载选项失败:', error);
                elements.optionsContainer.innerHTML = `
                    <div class="text-center py-8 text-danger">
                        <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>加载选项失败，请点击刷新重试</p>
                        <button id="retry-load" class="mt-3 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg">
                            <i class="fa fa-refresh mr-1"></i> 重试
                        </button>
                    </div>
                `;
                document.getElementById('retry-load').addEventListener('click', () => loadWord(index));
            }
        }

        // 检查答案
        function checkAnswer(button, isCorrect) {
            gameData.attempts[gameData.currentWordIndex]++;
            
            // 禁用所有选项
            document.querySelectorAll('#options-container button').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:border-primary', 'hover:bg-primary/5');
            });
            
            elements.feedback.classList.remove('hidden');
            
            if (isCorrect) {
                button.classList.add('bg-secondary/20', 'border-secondary', 'text-secondary');
                elements.feedback.textContent = '正确！太棒了！';
                elements.feedback.className = 'p-4 rounded-lg text-center font-medium bg-secondary/20 text-secondary';
                setTimeout(nextWord, 600);
            } else {
                button.classList.add('bg-danger/20', 'border-danger', 'text-danger');
                elements.feedback.textContent = '不正确，请再试一次！';
                elements.feedback.className = 'p-4 rounded-lg text-center font-medium bg-danger/20 text-danger';
                
                if (!gameData.mistakes.includes(gameData.currentWordIndex)) {
                    gameData.mistakes.push(gameData.currentWordIndex);
                }
                
                setTimeout(() => {
                    document.querySelectorAll('#options-container button').forEach(btn => {
                        btn.disabled = false;
                        btn.classList.add('hover:border-primary', 'hover:bg-primary/5');
                        btn.classList.remove('bg-danger/20', 'border-danger', 'text-danger');
                    });
                    elements.feedback.classList.add('hidden');
                }, 1500);
            }
        }

        // 下一个单词
        function nextWord() {
            gameData.currentWordIndex++;
            
            if (gameData.currentWordIndex < gameData.words.length) {
                loadWord(gameData.currentWordIndex);
            } else {
                endGame();
            }
        }

        // 结束游戏
        function endGame() {
            stopTimer();
            
            elements.gameSection.classList.add('hidden');
            elements.resultsSection.classList.remove('hidden');
            
            const totalCorrect = gameData.words.length - gameData.mistakes.length;
            const accuracyRate = Math.round((totalCorrect / gameData.words.length) * 100);
            
            elements.totalQuestions.textContent = gameData.words.length;
            elements.accuracy.textContent = `${accuracyRate}%`;
            
            const minutes = Math.floor(gameData.secondsElapsed / 60);
            const seconds = gameData.secondsElapsed % 60;
            elements.totalTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (gameData.mistakes.length === 0) {
                elements.mistakesList.innerHTML = 
                    '<p class="text-center text-green-600 py-4">恭喜！没有错误单词！</p>';
            } else {
                elements.mistakesList.innerHTML = '';
                gameData.mistakes.forEach(index => {
                    const wordData = gameData.words[index];
                    const div = document.createElement('div');
                    div.className = 'bg-light p-4 rounded-lg border border-danger/20';
                    div.innerHTML = `
                        <div class="font-semibold text-lg mb-1">${wordData.word}</div>
                        <div class="text-gray-700">正确释义: <span class="text-secondary font-medium">${wordData.correctMeaning}</span></div>
                        <div class="text-gray-600 text-sm mt-1">尝试次数: ${gameData.attempts[index]}</div>
                    `;
                    elements.mistakesList.appendChild(div);
                });
            }
        }

        // 计时器功能
        function startTimer() {
            gameData.timerInterval = setInterval(() => {
                gameData.secondsElapsed++;
                const minutes = Math.floor(gameData.secondsElapsed / 60);
                const seconds = gameData.secondsElapsed % 60;
                elements.timerDisplay.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(gameData.timerInterval);
        }

        // 复制链接功能
        function copyLinkToClipboard() {
            const link = elements.gameShareLink.value;
            if (!link) return;
            
            navigator.clipboard.writeText(link).then(() => {
                const originalText = elements.copyLinkBtn.innerHTML;
                elements.copyLinkBtn.innerHTML = '<i class="fa fa-check mr-1"></i>已复制';
                elements.copyLinkBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
                elements.copyLinkBtn.classList.add('bg-secondary');
                
                setTimeout(() => {
                    elements.copyLinkBtn.innerHTML = originalText;
                    elements.copyLinkBtn.classList.remove('bg-secondary');
                    elements.copyLinkBtn.classList.add('bg-primary', 'hover:bg-primary/90');
                }, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制链接');
            });
        }

        // 事件监听
        elements.startGameBtn.addEventListener('click', startGame);
        elements.resetBtn.addEventListener('click', () => {
            if (confirm('确定要重新开始游戏吗？')) {
                stopTimer();
                startGame();
            }
        });

        elements.reviewAgainBtn.addEventListener('click', () => {
            const mistakeWords = gameData.mistakes.map(index => gameData.words[index]);
            gameData.words = mistakeWords;
            generateShareLink();
            elements.resultsSection.classList.add('hidden');
            startGame();
        });

        elements.newGameBtn.addEventListener('click', () => {
            elements.resultsSection.classList.add('hidden');
            elements.resetBtn.classList.add('hidden');
            elements.wordInputSection.classList.remove('hidden');
        });

        elements.importWordsBtn.addEventListener('click', importWords);
        elements.copyLinkBtn.addEventListener('click', copyLinkToClipboard);

        // 初始化
        window.addEventListener('load', () => {
            const loaded = loadWordsFromUrl();
            if (!loaded) {
                updateWordList();
            }
        });
    </script>
</body>
</html>
    
